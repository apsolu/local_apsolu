{"version":3,"file":"attendance.min.js","sources":["../src/attendance.js"],"sourcesContent":["define([\"jquery\", \"enrol_select/jquery.popupoverlay\"], function($) {\n    return {\n        initialise : function() {\n            // Créé un bouton pour cocher toutes les présences non définies.\n            $('#apsolu-attendance-table').before('<div id=\"apsolu-attendance-check-javascript-helper\" class=\"text-right\"><p>Pour les présences <u>non saisies</u> :<ul class=\"list-inline\">'+\n                '<li class=\"list-inline-item\"><span class=\"btn btn-sm btn-primary\" id=\"apsolu-check-radio-present\">Cocher \"présent\" pour tous</span></li>'+\n                '<li class=\"list-inline-item\"><span class=\"btn btn-sm btn-primary\" id=\"apsolu-check-radio-absent\">Cocher \"absent\" pour tous</span></li>'+\n                '<li class=\"list-inline-item\"><span class=\"btn btn-sm btn-dark\" id=\"apsolu-check-radio-uncheck\">Décocher toutes les cases</span></li>'+\n                '</ul></div>');\n\n            // Ajoute un évènement sur le bouton \"présent\" créé précédemment.\n            $('#apsolu-check-radio-present').click(function(){\n                $('#apsolu-attendance-table tbody tr').each(function() {\n                    // Recherche si un des 4 boutons radio est coché.\n                    if ($(this).find('input[type=radio]:checked').length == 0) {\n                        // Coche le premier bouton radio de la liste.\n                        $(this).find('input[type=radio]').first().prop('checked', true);\n                    }\n                });\n            });\n\n            // Ajoute un évènement sur le bouton \"absent\" créé précédemment.\n            $('#apsolu-check-radio-absent').click(function(){\n                $('#apsolu-attendance-table tbody tr').each(function() {\n                    // Recherche si un des 4 boutons radio est coché.\n                    if ($(this).find('input[type=radio]:checked').length == 0) {\n                        // Coche le dernier bouton radio de la liste.\n                        $(this).find('input[type=radio]').last().prop('checked', true);\n                    }\n                });\n            });\n\n            // Ajoute un évènement sur le bouton \"décocher\" créé précédemment.\n            $('#apsolu-check-radio-uncheck').click(function(){\n                $('#apsolu-attendance-table tbody tr').each(function() {\n                    // Recherche si un des 4 boutons radio est coché.\n                    if ($(this).find('input[type=radio]:checked').length != 0) {\n                        // Décoche toutes les boutons.\n                        $(this).find('input[type=radio]').prop('checked', false);\n                    }\n                });\n            });\n\n            // Ajoute un évènement pour permettre de désélectionner un bouton radio.\n            $('#apsolu-attendance-table tbody tr input[type=radio]').click(function() {\n                // Supprime la propriété hasbeenpreviouslychecked sur tous les éléments radio, sauf l'élément courant.\n                var name = $(this).attr('name');\n                $('#apsolu-attendance-table tbody tr input[name=\"'+name+'\"]').not(this).removeProp('hasbeenpreviouslychecked');\n\n                if (this.hasbeenpreviouslychecked) {\n                    // Décoche le bouton radio qui était déjà coché avant.\n                    this.checked = false;\n                    $(this).removeProp('hasbeenpreviouslychecked');\n                } else {\n                    // Place une propriété indiquant que le bouton radio est déjà coché.\n                    this.hasbeenpreviouslychecked = true;\n                }\n            });\n\n            // Ajoute un évènement sur le bouton \"modifier l'inscription\".\n            $('.apsolu-attendance-edit-enrolments').click(function(event) {\n                event.preventDefault();\n\n                var popup = $('#apsolu-attendance-popup');\n                if (popup.length == 0) {\n                    $('#page-footer').append('<div id=\"apsolu-attendance-popup\"></div>');\n                    popup = $('#apsolu-attendance-popup');\n                }\n\n                data = new Object();\n                data.userid = $(this).data('userid');\n                data.courseid = $(this).data('courseid');\n                data.enrolid = $(this).data('enrolid');\n                data.statusid = $(this).data('statusid');\n                data.roleid = $(this).data('roleid');\n\n                // Build form.\n                $.ajax({\n                    url: M.cfg.wwwroot+\"/local/apsolu/attendance/ajax/edit_enrolment.php\",\n                    type: 'POST',\n                    data: data,\n                    dataType: 'json'\n                })\n                .done(function(result){\n                    try {\n                        $('#apsolu-attendance-popup').html(result.form);\n                        apsolu_attendance_handle_edit_enrolments_form();\n                    } catch(e) {\n                        console.log(e);\n                        // $('#apsolu-enrol-form').html(result);\n                    }\n                });\n\n                popup.css({backgroundColor: '#EEEEEE', padding: '.5em', cursor: 'default', maxWidth: '50%', textAlign: 'justify'});\n                popup.popup('show');\n            });\n\n            function apsolu_attendance_handle_edit_enrolments_form() {\n                // Submit data.\n                $('#apsolu-attendance-ajax-edit-enrolment form').submit(function(event) {\n                    event.preventDefault();\n\n                    // Supprime le précédent popup afin de donner un indice visuel en cas de renvoi du formulaire.\n                    var popup = document.querySelector(\"#apsolu-attendance-popup .alert\");\n                    if (popup !== null) {\n                        popup.remove();\n                    }\n\n                    $.ajax({\n                        url: M.cfg.wwwroot+\"/local/apsolu/attendance/ajax/edit_enrolment.php\",\n                        type: 'POST',\n                        data: $('#apsolu-attendance-ajax-edit-enrolment form').serialize(),\n                        dataType: 'json'\n                    })\n                    .done(function(result){\n                        $('#apsolu-attendance-popup').html(result.form);\n\n                        // Mets à jour la colonne \"Liste d'inscription\".\n                        var status = $('.apsolu-attendance-status[data-userid='+result.userid+']');\n                        if (status.length == 1) {\n                            status.html(result.status);\n                            $('.apsolu-attendance-edit-enrolments[data-userid='+result.userid+']').data('statusid', result.statusid);\n                        }\n\n                        // Mets à jour la colonne \"Type d'inscription\".\n                        var role = $('.apsolu-attendance-role[data-userid='+result.userid+']');\n                        if (role.length == 1) {\n                            role.html(result.role);\n                            $('.apsolu-attendance-edit-enrolments[data-userid='+result.userid+']').data('roleid', result.roleid);\n                        }\n\n                        apsolu_attendance_handle_edit_enrolments_form();\n                    });\n                });\n\n                // Close form.\n                $('#apsolu-attendance-ajax-edit-enrolment form .cancel').click(function(event) {\n                    event.preventDefault();\n\n                    var popup = $('#apsolu-attendance-popup');\n                    popup.popup('hide');\n                });\n            }\n        },\n        setupcourse : function() {\n            // Affiche les raccourcis de gestion de cours en haut de la page d'accueil du cours.\n\n            // Récupère le bouton \"gérer mes étudiants\".\n            var btn1 = document.getElementById('block-apsolu-course-edit-enrol-a');\n\n            // Récupère le bouton \"prendre les présences\".\n            var btn2 = document.getElementById('block-apsolu-course-edit-attendance-a');\n\n            if (!btn1 && !btn2) {\n                // Si aucun bouton n'est pas présent, ce que l'utilisateur n'est pas enseignant.\n                return;\n            }\n\n            var box = document.getElementById('page-content');\n            if (box) {\n                // Créer une liste avec les boutons et les places en haut de la page du cours.\n                var ul = document.createElement('ul');\n                ul.className = 'list-inline text-center';\n\n                var li;\n                var elements = [btn1, btn2];\n                for (var i = 0; i < elements.length; i++) {\n                    if (!elements[i]) {\n                        continue;\n                    }\n\n                    li = document.createElement('li');\n                    li.className = 'list-inline-item my-2';\n                    li.append(elements[i].cloneNode(true));\n                    ul.append(li);\n                }\n\n                box.prepend(ul);\n            }\n        }\n    };\n});\n"],"names":["define","$","initialise","apsolu_attendance_handle_edit_enrolments_form","submit","event","preventDefault","popup","document","querySelector","remove","ajax","url","M","cfg","wwwroot","type","data","serialize","dataType","done","result","html","form","status","userid","length","statusid","role","roleid","click","before","each","this","find","first","prop","last","name","attr","not","removeProp","hasbeenpreviouslychecked","checked","append","Object","courseid","enrolid","e","console","log","css","backgroundColor","padding","cursor","maxWidth","textAlign","setupcourse","btn1","getElementById","btn2","box","li","ul","createElement","className","elements","i","cloneNode","prepend"],"mappings":"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"}