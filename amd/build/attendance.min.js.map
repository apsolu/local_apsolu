{"version":3,"file":"attendance.min.js","sources":["../src/attendance.js"],"sourcesContent":["define([\"jquery\", \"enrol_select/jquery.popupoverlay\"], function($) {\n    return {\n        initialise: function() {\n            // Créé un bouton dropdown pour cocher toutes les présences non définies.\n            let selector = '#apsolu-attendance-table tbody tr:first-child .apsolu-attendance-status-form input';\n            let attendancestatus = document.querySelectorAll(selector);\n\n            if (attendancestatus) {\n                // Génère le bouton dropdown avec la liste des motifs de présences disponibles.\n                let dropdown = '<div class=\"dropdown\">' +\n                    '<button class=\"btn btn-primary dropdown-toggle\" type=\"button\" id=\"apsolu-dropdown-status-selector\"' +\n                    ' data-toggle=\"dropdown\" aria-haspopup=\"true\" aria-expanded=\"false\">' +\n                    'Pour les présences <u>non saisies</u> :' +\n                    '</button>' +\n                    '<div class=\"dropdown-menu\" aria-labelledby=\"apsolu-dropdown-status-selector\">';\n                for (let i = 0; i < attendancestatus.length; i++) {\n                    let state = attendancestatus[i];\n                    dropdown += '<button class=\"apsolu-status-selector dropdown-item\" data-value=\"' + state.value + '\">' +\n                        'Cocher \"' + state.parentNode.textContent.trim() + '\"' +\n                        '</button>';\n                }\n\n                // Ajoute une option permettant de décocher toutes les présences.\n                dropdown += '<div class=\"dropdown-divider\"></div>' +\n                    '<button class=\"apsolu-status-selector dropdown-item\" data-value=\"0\">Tout décocher</button>' +\n                    '</div></div>';\n\n                let quickform = document.createElement('div');\n                quickform.id = 'apsolu-attendance-check-javascript-helper';\n                quickform.classList = 'text-right';\n                quickform.innerHTML = dropdown;\n\n                // Ajoute le bouton dropdown au dessus du tableau des présences.\n                let table = document.getElementById('apsolu-attendance-table');\n                table.parentNode.insertBefore(quickform, table);\n\n                // Ajoute les évènements sur les boutons dropdown pour gérer les actions.\n                document.querySelectorAll('.apsolu-status-selector').forEach(function(btn) {\n                    btn.addEventListener('click', function(evnt) {\n                        evnt.preventDefault(); // Prevent default click event.\n\n                        $('#apsolu-attendance-table tbody tr').each(function() {\n                            // Détermine si un des boutons radio est coché.\n                            let ischecked = $(this).find('input[type=radio]:checked').length != 0;\n                            let value = btn.getAttribute('data-value');\n\n                            if (value == 0) {\n                                // Le bouton \"décocher\" a été sélectionné.\n                                if (ischecked) {\n                                    // Si un des boutons radio est coché dans la liste, on le décoche.\n                                    $(this).find('input[type=radio]').prop('checked', false);\n                                }\n                            } else {\n                                // Un des boutons de présences a été sélectionné.\n                                if (!ischecked) {\n                                    // Coche le bouton radio de la liste correspondant à la présence sélectionnée.\n                                    $(this).find('input[type=radio][value=' + value + ']').prop('checked', true);\n                                }\n                            }\n                        });\n                    });\n                });\n            }\n\n            // Ajoute un évènement pour permettre de désélectionner un bouton radio.\n            $('#apsolu-attendance-table tbody tr input[type=radio]').click(function() {\n                // Supprime la propriété hasbeenpreviouslychecked sur tous les éléments radio, sauf l'élément courant.\n                var name = $(this).attr('name');\n                $('#apsolu-attendance-table tbody tr input[name=\"'+name+'\"]').not(this).removeProp('hasbeenpreviouslychecked');\n\n                if (this.hasbeenpreviouslychecked) {\n                    // Décoche le bouton radio qui était déjà coché avant.\n                    this.checked = false;\n                    $(this).removeProp('hasbeenpreviouslychecked');\n                } else {\n                    // Place une propriété indiquant que le bouton radio est déjà coché.\n                    this.hasbeenpreviouslychecked = true;\n                }\n            });\n\n            // Ajoute un évènement sur le bouton \"modifier l'inscription\".\n            $('.apsolu-attendance-edit-enrolments').click(function(event) {\n                event.preventDefault();\n\n                var popup = $('#apsolu-attendance-popup');\n                if (popup.length == 0) {\n                    $('#page-footer').append('<div id=\"apsolu-attendance-popup\"></div>');\n                    popup = $('#apsolu-attendance-popup');\n                }\n\n                data = new Object();\n                data.userid = $(this).data('userid');\n                data.courseid = $(this).data('courseid');\n                data.enrolid = $(this).data('enrolid');\n                data.statusid = $(this).data('statusid');\n                data.roleid = $(this).data('roleid');\n\n                // Build form.\n                $.ajax({\n                    url: M.cfg.wwwroot+\"/local/apsolu/attendance/ajax/edit_enrolment.php\",\n                    type: 'POST',\n                    data: data,\n                    dataType: 'json'\n                })\n                .done(function(result){\n                    try {\n                        $('#apsolu-attendance-popup').html(result.form);\n                        apsolu_attendance_handle_edit_enrolments_form();\n                    } catch(e) {\n                        console.log(e);\n                        // $('#apsolu-enrol-form').html(result);\n                    }\n                });\n\n                popup.css({backgroundColor: '#EEEEEE', padding: '.5em', cursor: 'default', maxWidth: '50%', textAlign: 'justify'});\n                popup.popup('show');\n            });\n\n            function apsolu_attendance_handle_edit_enrolments_form() {\n                // Submit data.\n                $('#apsolu-attendance-ajax-edit-enrolment form').submit(function(event) {\n                    event.preventDefault();\n\n                    // Supprime le précédent popup afin de donner un indice visuel en cas de renvoi du formulaire.\n                    var popup = document.querySelector(\"#apsolu-attendance-popup .alert\");\n                    if (popup !== null) {\n                        popup.remove();\n                    }\n\n                    $.ajax({\n                        url: M.cfg.wwwroot+\"/local/apsolu/attendance/ajax/edit_enrolment.php\",\n                        type: 'POST',\n                        data: $('#apsolu-attendance-ajax-edit-enrolment form').serialize(),\n                        dataType: 'json'\n                    })\n                    .done(function(result){\n                        $('#apsolu-attendance-popup').html(result.form);\n\n                        // Mets à jour la colonne \"Liste d'inscription\".\n                        var status = $('.apsolu-attendance-status[data-userid='+result.userid+']');\n                        if (status.length == 1) {\n                            status.html(result.status);\n                            $('.apsolu-attendance-edit-enrolments[data-userid='+result.userid+']').data('statusid', result.statusid);\n                        }\n\n                        // Mets à jour la colonne \"Type d'inscription\".\n                        var role = $('.apsolu-attendance-role[data-userid='+result.userid+']');\n                        if (role.length == 1) {\n                            role.html(result.role);\n                            $('.apsolu-attendance-edit-enrolments[data-userid='+result.userid+']').data('roleid', result.roleid);\n                        }\n\n                        apsolu_attendance_handle_edit_enrolments_form();\n                    });\n                });\n\n                // Close form.\n                $('#apsolu-attendance-ajax-edit-enrolment form .cancel').click(function(event) {\n                    event.preventDefault();\n\n                    var popup = $('#apsolu-attendance-popup');\n                    popup.popup('hide');\n                });\n            }\n        },\n        setupcourse : function() {\n            // Affiche les raccourcis de gestion de cours en haut de la page d'accueil du cours.\n\n            // Récupère le bouton \"gérer mes étudiants\".\n            var btn1 = document.getElementById('block-apsolu-course-edit-enrol-a');\n\n            // Récupère le bouton \"prendre les présences\".\n            var btn2 = document.getElementById('block-apsolu-course-edit-attendance-a');\n\n            if (!btn1 && !btn2) {\n                // Si aucun bouton n'est pas présent, ce que l'utilisateur n'est pas enseignant.\n                return;\n            }\n\n            var box = document.getElementById('page-content');\n            if (box) {\n                // Créer une liste avec les boutons et les places en haut de la page du cours.\n                var ul = document.createElement('ul');\n                ul.className = 'list-inline text-center';\n\n                var li;\n                var elements = [btn1, btn2];\n                for (var i = 0; i < elements.length; i++) {\n                    if (!elements[i]) {\n                        continue;\n                    }\n\n                    li = document.createElement('li');\n                    li.className = 'list-inline-item my-2';\n                    li.append(elements[i].cloneNode(true));\n                    ul.append(li);\n                }\n\n                box.prepend(ul);\n            }\n        }\n    };\n});\n"],"names":["define","$","initialise","attendancestatus","document","querySelectorAll","dropdown","i","length","state","value","parentNode","textContent","trim","quickform","createElement","id","classList","innerHTML","table","getElementById","insertBefore","forEach","btn","addEventListener","evnt","preventDefault","each","ischecked","this","find","getAttribute","prop","apsolu_attendance_handle_edit_enrolments_form","submit","event","popup","querySelector","remove","ajax","url","M","cfg","wwwroot","type","data","serialize","dataType","done","result","html","form","status","userid","statusid","role","roleid","click","name","attr","not","removeProp","hasbeenpreviouslychecked","checked","append","Object","courseid","enrolid","e","console","log","css","backgroundColor","padding","cursor","maxWidth","textAlign","setupcourse","btn1","btn2","box","li","ul","className","elements","cloneNode","prepend"],"mappings":"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"}