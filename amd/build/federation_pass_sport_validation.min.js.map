{"version":3,"file":"federation_pass_sport_validation.min.js","sources":["../src/federation_pass_sport_validation.js"],"sourcesContent":["define(['jquery', 'core_form/modalform', 'core/str', 'core/toast'], function($, ModalForm, Str, notifyUser) {\n    return {\n        initialise: function() {\n            $('.local-apsolu-federation-pass-sport-validation').click(function(event) {\n                event.preventDefault();\n\n                var link = event.target;\n                if (link.tagName !== 'A') {\n                    // Des fois, l'event match sur la <span>, des fois sur le <a>...\n                    link = event.target.parentElement;\n                }\n\n                var strings = [\n                    {\n                        key: link.getAttribute('data-stringid') + '_subject',\n                        component: 'local_apsolu'\n                    },\n                    {\n                        key: link.getAttribute('data-stringid') + '_body',\n                        component: 'local_apsolu'\n                    }\n                ];\n\n                Str.get_strings(strings).then(function (results) {\n                    var subject = results[0];\n                    var body = results[1];\n\n                    var contextid = link.getAttribute('data-contextid');\n                    var targetvalidation = link.getAttribute('data-target-validation');\n                    var targetvalidationcolor = link.getAttribute('data-target-validation-color');\n                    var targetvalidationtext = link.getAttribute('data-target-validation-text');\n                    var users = link.getAttribute('data-users');\n\n                    var title = link.textContent;\n\n                    const modalForm = new ModalForm({\n                        formClass: \"local_apsolu\\\\form\\\\federation\\\\validate_pass_sport\",\n                        args: {users: users, contextid: contextid,\n                            jsondata: targetvalidation, subject: subject, body: body},\n                        modalConfig: {title: title, large: true, buttons: {save: Str.get_string('send', 'message')}},\n                    });\n\n                    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, (e) => {\n                        let countnotifications = 0;\n                        let errors = [];\n                        let i = 0;\n\n                        // Lecture de la réponse du formulaire.\n                        let message;\n                        for (i = 0; i < e.detail.length; i++) {\n                            message = e.detail[i];\n                            if (message.msgid) {\n                                countnotifications++;\n                            } else {\n                                errors.push(message.errormessage);\n                            }\n                        }\n\n                        // Préparation de la notification.\n                        if (countnotifications > 0) {\n                            if (countnotifications == 1) {\n                                Str.get_string('message_sent', 'local_apsolu')\n                                    .then(message => {\n                                        console.log(message); // eslint-disable-line no-console\n                                        return notifyUser.add(message);\n                                    })\n                                    .fail(Notification.exception); // eslint-disable-line no-restricted-globals\n                            } else {\n                                Str.get_string('messages_sent_to_X_users', 'local_apsolu', countnotifications)\n                                    .then(message => {\n                                        console.log(message); // eslint-disable-line no-console\n                                        return notifyUser.add(message);\n                                    })\n                                    .fail(Notification.exception); // eslint-disable-line no-restricted-globals\n                            }\n                        }\n\n                        if (errors.length > 0) {\n                            for (i = 0; i < errors.length; i++) {\n                                console.log(message); // eslint-disable-line no-console\n                                notifyUser.add(errors[i]);\n                            }\n                        } else {\n                            // Mise à jour du libellé de l'état du certificat.\n                            let items = users.split(',');\n                            let element, menuitem;\n                            for (let i = 0; i < items.length; i++) {\n                                element = document.querySelector('td.pass-sport-status[data-userid=\"'+items[i]+'\"]');\n                                if (element) {\n                                    element.textContent = targetvalidationtext;\n                                    element.classList.remove('table-success', 'table-warning', 'table-danger', 'table-info');\n                                    if (targetvalidationcolor !== '') {\n                                        element.classList.add(targetvalidationcolor);\n                                    }\n\n                                    menuitem = document.querySelector('a.dropdown-item[data-users=\"'+items[i]+'\"]');\n                                    if (menuitem) {\n                                        // Supprime le dropdown \"modifier\".\n                                        let menuitemcontainer = menuitem.closest('.action-menu');\n                                        if (menuitemcontainer) {\n                                            menuitemcontainer.remove();\n                                        }\n                                    }\n                                }\n                            }\n                        }\n                    });\n\n                    modalForm.show();\n                });\n            });\n        }\n    };\n});\n"],"names":["define","$","ModalForm","Str","notifyUser","initialise","click","event","preventDefault","link","target","tagName","parentElement","strings","key","getAttribute","component","get_strings","then","results","subject","body","contextid","targetvalidation","targetvalidationcolor","targetvalidationtext","users","title","textContent","modalForm","formClass","args","jsondata","modalConfig","large","buttons","save","get_string","addEventListener","events","FORM_SUBMITTED","e","message","countnotifications","errors","i","detail","length","msgid","push","errormessage","console","log","add","fail","Notification","exception","element","menuitem","items","split","document","querySelector","classList","remove","menuitemcontainer","closest","show"],"mappings":"AAAAA,uDAAO,CAAC,SAAU,sBAAuB,WAAY,eAAe,SAASC,EAAGC,UAAWC,IAAKC,kBACrF,CACHC,WAAY,WACRJ,EAAE,kDAAkDK,OAAM,SAASC,OAC/DA,MAAMC,qBAEFC,KAAOF,MAAMG,OACI,MAAjBD,KAAKE,UAELF,KAAOF,MAAMG,OAAOE,mBAGpBC,QAAU,CACV,CACIC,IAAKL,KAAKM,aAAa,iBAAmB,WAC1CC,UAAW,gBAEf,CACIF,IAAKL,KAAKM,aAAa,iBAAmB,QAC1CC,UAAW,iBAInBb,IAAIc,YAAYJ,SAASK,MAAK,SAAUC,aAChCC,QAAUD,QAAQ,GAClBE,KAAOF,QAAQ,GAEfG,UAAYb,KAAKM,aAAa,kBAC9BQ,iBAAmBd,KAAKM,aAAa,0BACrCS,sBAAwBf,KAAKM,aAAa,gCAC1CU,qBAAuBhB,KAAKM,aAAa,+BACzCW,MAAQjB,KAAKM,aAAa,cAE1BY,MAAQlB,KAAKmB,kBAEXC,UAAY,IAAI3B,UAAU,CAC5B4B,UAAW,sDACXC,KAAM,CAACL,MAAOA,MAAOJ,UAAWA,UAC5BU,SAAUT,iBAAkBH,QAASA,QAASC,KAAMA,MACxDY,YAAa,CAACN,MAAOA,MAAOO,OAAO,EAAMC,QAAS,CAACC,KAAMjC,IAAIkC,WAAW,OAAQ,eAGpFR,UAAUS,iBAAiBT,UAAUU,OAAOC,gBAAiBC,QAMrDC,QALAC,mBAAqB,EACrBC,OAAS,GACTC,EAAI,MAIHA,EAAI,EAAGA,EAAIJ,EAAEK,OAAOC,OAAQF,IAC7BH,QAAUD,EAAEK,OAAOD,GACfH,QAAQM,MACRL,qBAEAC,OAAOK,KAAKP,QAAQQ,iBAKxBP,mBAAqB,IACK,GAAtBA,mBACAxC,IAAIkC,WAAW,eAAgB,gBAC1BnB,MAAKwB,UACFS,QAAQC,IAAIV,SACLtC,WAAWiD,IAAIX,YAEzBY,KAAKC,aAAaC,WAEvBrD,IAAIkC,WAAW,2BAA4B,eAAgBM,oBACtDzB,MAAKwB,UACFS,QAAQC,IAAIV,SACLtC,WAAWiD,IAAIX,YAEzBY,KAAKC,aAAaC,YAI3BZ,OAAOG,OAAS,MACXF,EAAI,EAAGA,EAAID,OAAOG,OAAQF,IAC3BM,QAAQC,IAAIV,SACZtC,WAAWiD,IAAIT,OAAOC,QAEvB,KAGCY,QAASC,SADTC,MAAQjC,MAAMkC,MAAM,SAEnB,IAAIf,EAAI,EAAGA,EAAIc,MAAMZ,OAAQF,OAC9BY,QAAUI,SAASC,cAAc,qCAAqCH,MAAMd,GAAG,MAC3EY,UACAA,QAAQ7B,YAAcH,qBACtBgC,QAAQM,UAAUC,OAAO,gBAAiB,gBAAiB,eAAgB,cAC7C,KAA1BxC,uBACAiC,QAAQM,UAAUV,IAAI7B,uBAG1BkC,SAAWG,SAASC,cAAc,+BAA+BH,MAAMd,GAAG,MACtEa,UAAU,KAENO,kBAAoBP,SAASQ,QAAQ,gBACrCD,mBACAA,kBAAkBD,cAQ1CnC,UAAUsC"}