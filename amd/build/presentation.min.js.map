{"version":3,"file":"presentation.min.js","sources":["../src/presentation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module javascript pour l'offre de formations.\n *\n * @module     local_apsolu/presentation\n * @copyright  2020 Université Rennes 2 <dsi-contact@univ-rennes2.fr>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/modal_events', 'core/modal_factory', 'core/templates', 'enrol_select/select2'],\n    function($, ModalEvents, ModalFactory, templates) {\n\n    return {\n        initialise: function() {\n            /**\n             * Fonction permettant de filtrer l'offre de formations.\n             *\n             */\n            function filter() {\n                // Filtre le tableau de l'offre de formations.\n                var filters = {};\n\n                // Réaffiche toutes les lignes pour mieux les masquer ensuite.\n                $('#apsolu-presentation-table tbody tr').css('display', 'table-row');\n\n                $('.apsolu-presentation-selects').each(function() {\n                    var values = $(this).select2('data');\n                    var target = $(this).attr('name');\n                    if (values.length === 0) {\n                        // Ne pas parcourir le tableau entier, si il n'y a aucun filtre pour cette colonne.\n                        return;\n                    }\n\n                    filters[target] = [];\n                    for (var i = 0; i < values.length; i++) {\n                        filters[target].push(values[i].id);\n                    }\n\n                    var header;\n                    var headerChildren;\n\n                    $('#apsolu-presentation-table tbody tr').each(function() {\n                        if ($(this).children().length === 1) {\n                            // On ne traite pas les <th>, mais on les masque si elles ne servent à rien.\n                            if (headerChildren === 0) {\n                                header.css('display', 'none');\n                            }\n\n                            header = $(this);\n                            headerChildren = 0;\n\n                            return;\n                        }\n\n                        if ($(this).css('display') === 'none') {\n                            // Ne pas parcourir le tableau entier, si la ligne est déjà masquée.\n                            return;\n                        }\n\n                        // Pour chaque valeur sélectionnée dans le widget select2...\n                        for (var i = 0; i < values.length; i++) {\n                            var match = false;\n                            var value = $.trim($(this).children('[data-column=\"' + target + '\"]').attr('data-value'));\n\n                            if (target === \"period\" || target === \"role\" || target === \"teachers\") {\n                                // On fait une recherche partielle sur les champs périodes, roles et enseignants.\n                                match = (value.indexOf(values[i].text) !== -1);\n                            } else {\n                                // On fait une recherche strict sur les autres champs.\n                                match = (values[i].text === value);\n                            }\n\n                            if (match === true) {\n                                // Si la valeur correspond au filtre, on continue...\n                                headerChildren++;\n                                return;\n                            }\n                        }\n\n                        // On masque la ligne si la colonne ne correspond à aucun critère de recherche.\n                        $(this).css('display', 'none');\n                    });\n\n                    if (headerChildren === 0) {\n                        header.css('display', 'none');\n                    }\n                });\n\n                // Calcule le permalink.\n                var permalink = document.getElementById('apsolu-offerings-permalink-button');\n                if (permalink) {\n                    if (Object.keys(filters).length === 0) {\n                        permalink.setAttribute('disabled', 'disabled');\n                    } else {\n                        var anchor = window.btoa(unescape(encodeURIComponent(JSON.stringify(filters))));\n\n                        permalink.removeAttribute('disabled');\n                        permalink.setAttribute('data-href', '#' + anchor);\n                    }\n                }\n            }\n\n            // Initialise les entrées HTML du formulaire contenant les filtres.\n            $('.apsolu-presentation-selects').select2({\n                allowClear: true,\n                width: '18em'\n                });\n\n            // Appelle la fonction filter() à chaque changement de valeurs dans les entrées du formulaire.\n            $('.apsolu-presentation-selects').on('change.select2', function() {\n                filter();\n            });\n\n            // Lit le permalink dans l'ancre de l'URL.\n            var anchor = window.location.hash;\n\n            if (anchor.charAt(0) === '#') {\n                anchor = anchor.slice(1);\n            }\n\n            if (anchor != '') {\n                var selections = decodeURIComponent(escape(window.atob(anchor)));\n                try {\n                    selections = JSON.parse(selections);\n\n                    for (const selection in selections) {\n                        var select = $('.apsolu-presentation-selects[name=' + selection + ']');\n                        if (select) {\n                            select.val(selections[selection]);\n                            select.trigger('change');\n                        }\n                    }\n                } catch (error) {\n                    // TODO: améliorer la gestion d'erreurs : console.log(error);\n                }\n            }\n\n            // Initialise les filtres.\n            filter();\n\n            /**\n             * Fonction permettant d'alterner l'affichage du bloc de filtres.\n             *\n             */\n            function toggleFilterBlock() {\n                var filters = document.getElementById('apsolu-offerings-filters-aside');\n                if (filters) {\n                    if (filters.style.display == 'block') {\n                        filters.style.display = 'none';\n                    } else {\n                        filters.style.display = 'block';\n                    }\n                }\n            }\n\n            if (document.getElementsByClassName('select2-selection__choice').length > 0) {\n                // Affiche le bloc de filtres, si il y a déjà une selection en cours.\n                toggleFilterBlock();\n            }\n\n            var toggleFiltersButton = document.getElementById('toggle-filters-button');\n            if (toggleFiltersButton) {\n                // Positionne un évènement lors d'un clic sur le bouton d'affichage des filtres.\n                toggleFiltersButton.addEventListener('click', toggleFilterBlock);\n            }\n\n            // Ajoute une bulle d'aide pour ajouter les libellés complémentaires.\n            var complementaryrows = document.querySelectorAll('tr[data-category-event]');\n            if (complementaryrows.length > 0) {\n                var tdindex;\n\n                // On parcourt toutes les lignes du tableau des activités (tr).\n                for (var i = 0; i < complementaryrows.length; i++) {\n                    if (!tdindex) {\n                        // On détermine l'index de la première colonne visible.\n                        for (var j = 0; j < complementaryrows[i].children.length; j++) {\n                            if (complementaryrows[i].children[j].classList.contains('hide') === false) {\n                                tdindex = j;\n                                break;\n                            }\n                        }\n                    }\n\n                    var context = {event: complementaryrows[i].getAttribute('data-category-event')};\n                    var nodepath = '#' + complementaryrows[i].getAttribute('id') + ' td:eq(' + tdindex + ')';\n\n                    // Appelle le template local_apsolu/presentation_event_popover.\n                    var updateTemplate = function(templates, context, nodepath) {\n                        return templates.render('local_apsolu/presentation_event_popover', context)\n                            .then(function(html, js) {\n                                return templates.prependNodeContents(nodepath, html, js);\n                            });\n                    };\n                    updateTemplate(templates, context, nodepath);\n                }\n            }\n\n            // Gère la fenêtre pour les liens permanents.\n            var permalink = $('#apsolu-offerings-permalink-button');\n            if (permalink) {\n                ModalFactory.create({\n                    large: true,\n                }, permalink)\n                .done(function(modal) {\n                    // Do what you want with your new modal.\n                    modal.getRoot().on(ModalEvents.shown, function() {\n                        var href = window.location.href.split('#')[0];\n                        var permalink = document.getElementById('apsolu-offerings-permalink-button');\n                        var value = href + permalink.getAttribute('data-href');\n\n                        modal.setBody('<p><input id=\"apsolu-offerings-permalink-input\" size=\"75\" type=\"text\" value=\"' +\n                            value + '\" /></p>');\n                    });\n                });\n            }\n        }\n    };\n});\n"],"names":["define","$","ModalEvents","ModalFactory","templates","initialise","filter","filters","css","each","values","this","select2","target","attr","length","i","push","id","header","headerChildren","children","value","trim","indexOf","text","permalink","document","getElementById","Object","keys","setAttribute","anchor","window","btoa","unescape","encodeURIComponent","JSON","stringify","removeAttribute","allowClear","width","on","location","hash","charAt","slice","selections","decodeURIComponent","escape","atob","parse","selection","select","val","trigger","error","toggleFilterBlock","style","display","getElementsByClassName","toggleFiltersButton","addEventListener","complementaryrows","querySelectorAll","tdindex","j","classList","contains","context","event","getAttribute","nodepath","render","then","html","js","prependNodeContents","updateTemplate","create","large","done","modal","getRoot","shown","href","split","setBody"],"mappings":"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"}