define(['jquery','core/modal_events','core/modal_factory','core/templates','enrol_select/select2'],function($,ModalEvents,ModalFactory,templates){return{initialise:function(){function filter(){var filters={};$('#apsolu-enrol-select tbody tr').css('display','table-row');$('.apsolu-enrol-selects').each(function(){var values=$(this).select2('data');var target=$(this).attr('name');if(values.length===0){return;}
filters[target]=[];for(var i=0;i<values.length;i++){filters[target].push(values[i].id);}
var header;var headerChildren;$('#apsolu-enrol-select tbody tr').each(function(){if($(this).children().length===1){if(headerChildren===0){header.css('display','none');}
header=$(this);headerChildren=0;return;}
if($(this).css('display')==='none'){return;}
for(var i=0;i<values.length;i++){var match=false;var value=$.trim($(this).children('[data-column="'+target+'"]').attr('data-value'));if(target==="period"||target==="role"||target==="teachers"){match=(value.indexOf(values[i].text)!==-1);}else{match=(values[i].text===value);}
if(match===true){headerChildren++;return;}}
$(this).css('display','none');});if(headerChildren===0){header.css('display','none');}});var permalink=document.getElementById('apsolu-offerings-permalink-button');if(permalink){if(Object.keys(filters).length===0){permalink.setAttribute('disabled','disabled');}else{var anchor=window.btoa(unescape(encodeURIComponent(JSON.stringify(filters))));permalink.removeAttribute('disabled');permalink.setAttribute('data-href','#'+anchor);}}}
$('.apsolu-enrol-selects').select2({allowClear:true,width:'18em'});$('.apsolu-enrol-selects').on('change.select2',function(){filter();});var anchor=window.location.hash;if(anchor.charAt(0)==='#'){anchor=anchor.slice(1);}
if(anchor!=''){var selections=decodeURIComponent(escape(window.atob(anchor)));try{selections=JSON.parse(selections);for(selection in selections){var select=$('.apsolu-enrol-selects[name='+selection+']');if(select){select.val(selections[selection]);select.trigger('change');}}}catch(error){console.log(error);}}
filter();function toggleFilterBlock(){var filters=document.getElementById('apsolu-offerings-filters-aside');if(filters){if(filters.style.display=='block'){filters.style.display='none';}else{filters.style.display='block';}}}
if(document.getElementsByClassName('select2-selection__choice').length>0){toggleFilterBlock();}
var toggleFiltersButton=document.getElementById('toggle-filters-button');if(toggleFiltersButton){toggleFiltersButton.addEventListener('click',toggleFilterBlock);}
var complementaryrows=document.querySelectorAll('tr[data-category-event]');if(complementaryrows.length>0){var tdindex;for(var i=0;i<complementaryrows.length;i++){if(!tdindex){for(var j=0;j<complementaryrows[i].children.length;j++){if(complementaryrows[i].children[j].classList.contains('hide')===false){tdindex=j;break;}}}
var context={event:complementaryrows[i].getAttribute('data-category-event')};var nodepath='#'+complementaryrows[i].getAttribute('id')+' td:eq('+tdindex+')';var updateTemplate=function(templates,context,nodepath){templates.render('local_apsolu/presentation_event_popover',context).then(function(html,js){templates.prependNodeContents(nodepath,html,js);});};updateTemplate(templates,context,nodepath);}}
var permalink=$('#apsolu-offerings-permalink-button');if(permalink){ModalFactory.create({large:true,},permalink).done(function(modal){modal.getRoot().on(ModalEvents.shown,function(){var href=window.location.href.split('#')[0];var permalink=document.getElementById('apsolu-offerings-permalink-button');var value=href+permalink.getAttribute('data-href');modal.setBody('<p><input id="apsolu-offerings-permalink-input" size="75" type="text" value="'+value+'" /></p>');});});}}};});